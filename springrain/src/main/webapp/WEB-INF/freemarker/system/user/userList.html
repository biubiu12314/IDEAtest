<#escape x as x?html>
<link rel="stylesheet" href="${ctx}/ace/css/chosen.min.css" />
<script src="${ctx}/ace/js/chosen.jquery.min.js"></script>

<link rel="stylesheet" href="${ctx}/js/coms/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="${ctx}/js/coms/ztree/js/jquery.ztree.all-3.5.js"></script>
<script type="text/javascript" src="${ctx}/js/coms/common/ztreeUtils.js"></script>


<SCRIPT type="text/javascript">

jQuery(document).ready(function(){
	$('#roleIds').chosen({allow_single_deselect:true});
	$('#orgIds').chosen({allow_single_deselect:true});
	
	$(window).on('resize.chosen', function() {
		var w = $('.chosen-select').parent().width();
		$('.chosen-select').next().css({'width':w});
	}).trigger('resize.chosen');


	
	//加载角色
	jQuery.ajax({
		url : ctx+"/system/role/list/json",
		type : "post",
		dataType : "json",
		success : function(_json) {
			if(_json.status=="error"){
				return;
			}
			
			jQuery(_json.data).each(function(i,_obj){
				jQuery("#roleIds").append("<option value='"+_obj.id+"'>"+_obj.name+"</option>");
			});
			
			jQuery("#roleIds").trigger("chosen:updated");  
		}
	});
	
	
	
	//加载部门
	jQuery.ajax({
		url : ctx+"/system/org/list/json",
		type : "post",
		dataType : "json",
		success : function(_json) {
			if(_json.status=="error"){
				return;
			}
			
			jQuery(_json.data).each(function(i,_obj){
				jQuery("#orgIds").append("<option value='"+_obj.id+"'>"+_obj.name+"</option>");
			});
			
			jQuery("#orgIds").trigger("chosen:updated");  
		}
	});
	
	
	
	
	
	//回选 下拉框
	jQuery("#search_state option[value='${(returnDatas.queryBean.state)!'是'}']").prop("selected",true);
	
	$(".sub_left_menu tbody tr").click(function() {
		$("#pwdDiv").hide();
		$(".sub_left_menu tbody tr.active").removeClass("active");
		$(this).attr("class", "active");
		var _url=ctx + "/system/user/look/json?id="+ $(this).attr("id");
	
		jQuery.ajax({
			url : _url,
			type : "post",
			dataType : "json",
			success : function(_json) {
				if(_json.status=="success"){
					showdata(_json);
				}
			}
		});
		return false;
	})
	
});






function deleteUser(){
	var id=jQuery("#id").val();
	if(!id||id==""){
		myalert("请选择你要删除的记录");
		return;
	}else{
		var _url="${ctx}/system/user/delete?id="+id;
		var listurl="${ctx}/system/user/list";
		
		mydelete(_url,listurl);
	}
}

function showdata(result) {
	$("#btn_add").hide();
	$("#btn_reload").show();
	$("#btn_update").show();
	$("#btn_delete").show();
	
	
	
	for (var s in result.data) {
		set_val(s, result.data[s]);
	}
	jQuery("#account").prop("readonly",true);
	

	//回选 下拉框
	jQuery("#state option[value='"+result.data['state']+"']").prop("selected",true);
	  
	  jQuery("#password").val("");
	
	  $("#roleIds").find("option:selected").prop("selected",false);
	  jQuery(result.data["userRoles"]).each(function(i,_obj){
			jQuery("#roleIds option[value='"+_obj.id+"']").prop("selected",true);
	  });
	  jQuery("#roleIds").trigger("chosen:updated");  
	  
	  
	  

	  $("#orgIds").find("option:selected").prop("selected",false);
	  jQuery(result.data["userOrgs"]).each(function(i,_obj){
			jQuery("#orgIds option[value='"+_obj.id+"']").prop("selected",true);
	  });
	  jQuery("#orgIds").trigger("chosen:updated"); 
	  
	  

}

function check(type){
	var account = $('#account').val();
	if(account==null||account==""){
		myinfo("请填写账号!");
		return;
	}
	if((/[\u4e00-\u9fa5]+/).test(account) ){ 
		myinfo("账号不能含有汉字!");
		return;
		}
	if(type=="1"){
		var password = $('#password').val();
		if(password==null||password==""){
			myinfo("请填写密码!");
			return;
		}	
		//密码长度
		if(password.length<6){
			myinfo("密码长度不能少于6位!");
			return false;
		}
	}
	
	var username = $('#name').val();
	if(username==null||username.length==0){
		myinfo("请填写姓名!");
		return false;
	}
	
	var roleIds = $('#roleIds').val();
	if(roleIds==null||roleIds.length==0){
		myinfo("请填写角色!");
		return false;
	}
	
	
	var orgIds = $('#orgIds').val();
	if(orgIds==null||orgIds.length==0){
		myinfo("请填写部门!");
		return false;
	}


	
	var mobile=$("#mobile").val();
	if(mobile!="" && mobile!=null){
		 var reg = /^1\d{10}$/;
		 if(!reg.test(mobile)){
			 myinfo("手机号格式错误!");
				return false;
		 }
	}
	

	var listurl='${ctx}/system/user/list';
	commonUpdateForm("updateForm",listurl);
}

</SCRIPT>







<div class="operate panel panel-default" style="height:65px;">
	<div class="panel-body">
		<div class="pull-left">
<form class="form-horizontal" method="post"  action="${ctx}/system/user/list"  name="searchForm"  id="searchForm" onkeydown="if(event.keyCode==13)return false;" >
	<input type="hidden" name="pageIndex" id="pageIndex" value="${(returnDatas.page.pageIndex)!'1'}" />
<input type="hidden" name="sort" id="page_sort" value="${(returnDatas.page.sort)!'desc'}"  />
<input type="hidden" name="order" id="page_order" value="${(returnDatas.page.order)!'id'}"  />
			<label for="search_account"><b>账号:</b></label> 
			 <input type="text" id="search_account"  name="account" placeholder="请填写账号"  value="${(returnDatas.queryBean.account)!''}">
			
			<a  href="javascript:mySubmitForm('searchForm');"
				class="btn btn-purple btn-sm">
					查询 <i class="ace-icon fa fa-search icon-on-right bigger-10"></i>
				</a>

</form>
		</div>
		
		
		
		<div class="pull-right">
			
			
			 <@shiro.hasPermission
			name="/system/user/update" >
			<button id="btn_reload" onclick="location.reload();"
				class="btn  btn-sm  btn-primary " style="display: none;" >
				跳转至新增 >>
			</button>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			
			
			<button id="btn_add" onclick="check('1');"
				class="btn  btn-sm  btn-primary ">
				<img src="${ctx}/images/btn_save.png" style="vertical-align: middle;" />保存新增
			</button>

			<button  id="btn_update" onclick="check('2');"
				class="btn  btn-sm  btn-primary " style="display: none;">
				<img src="${ctx}/images/btn_save.png" style="vertical-align: middle;" />保存修改
			</button>

			</@shiro.hasPermission>
			
 			 <@shiro.hasPermission name="/system/user/delete" > 
 			<button  id="btn_delete"  onclick="deleteUser();" class="btn btn-sm btn-danger " style="display: none;"> 
 				 删除
 			</button>
			</@shiro.hasPermission> 
			
		</div>
			
			
			
		</div>
	</div>
</div>


<!-- /.page-header -->



<div class="row">
	<div class="col-xs-12">
		<div class="row">
			<div class="col-xs-12">
				<div class="col-sm-4 sub_left_menu ">
					<div class="widget-box">
						<div class="widget-header">
							<h4 class="widget-title">账号列表</h4>
						</div>
						<div class="widget-body">
							<div class="widget-main">
								<table class="table table-striped">
									<thead>
										<tr>
											<th>账号</th>
											<th>姓名</th>
											<th>手机号</th>
										
										</tr>
									</thead>
									<tbody>
									
								    <#if (returnDatas.data??)&&(returnDatas.data?size>0)>
									   <#list returnDatas.data as _data>
											<tr id="${(_data.id)!''}">
												<td>${(_data.account)!''}</td>
												<td>${(_data.name)!''}</td>
												<td>${(_data.mobile)!''}</td> 
											</tr>
				                         </#list>
									 </#if>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<div class="col-sm-8">
					<div class="widget-box">
						<div class="widget-header">
							<h4 class="widget-title">详细信息</h4>
						</div>
						<div class="widget-body">
							<div class="widget-main">
								<form class="form-horizontal clearfix" method="post"  action="${ctx}/system/user/update"  name="updateForm" id="updateForm">
									<input type="hidden" id="id" name="id" value=""> 
									<input type="hidden" id="pname" name="pname" value="">
									
									<div class="col-sm-6">
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right" for="account"> 账号<span  style="color:#E12424">*</span> </label>
										
											<div class="col-sm-9">
												<input type="text" id="account" name="account" placeholder="账号" class="form-control">
											</div>
										</div>
										<div class="form-group" id="pwdDiv">
											<label class="col-sm-3 control-label no-padding-right" for="password"> 密码<span  style="color:#E12424">*</span> </label>
										
											<div class="col-sm-9">
												<input type="password" id="password" name="password" placeholder="密码" class="form-control">
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right" for="name"> 姓名<span  style="color:#E12424">*</span> </label>
											<div class="col-sm-9">
												<input type="text" id="name" name="name" placeholder="姓名" class="form-control">
											</div>
										</div>
										
										
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right" for="orgIds"> 部门<span  style="color:#E12424">*</span> </label>
											<div class="col-sm-9">
												<select  id="orgIds" name="orgIds"   class="chosen-select"  multiple data-placeholder="请选择部门">
												</select>
											</div>
										</div>
										
										
										
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right" for="roleIds"> 角色<span  style="color:#E12424">*</span> </label>
											<div class="col-sm-9">
												<select  id="roleIds" name="roleIds"   class="chosen-select"  multiple data-placeholder="请选择角色">
												</select>
											</div>
										</div>
										
									</div>
									<div class="col-sm-5">
										
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right no-padding-left" for="mobile"> 手机号</label>
											<div class="col-sm-9">
												<input type="text" id="mobile" name="mobile" placeholder="手机号" class="form-control">
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right no-padding-left" for="email"> 电子邮箱 </label>
											<div class="col-sm-9">
												<input type="text" id="email" name="email" placeholder="电子邮箱" class="form-control">
											</div>
										</div>
										
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right" for="sex"> 性别</label>
											<div class="col-sm-9">
												<select class="form-control " id="sex" name="sex">
														<option value="男">男</option>
														<option value="女">女</option>
												</select>
											</div>
										</div>
										
										
										
										<div class="form-group">
											<label class="col-sm-3 control-label no-padding-right no-padding-left" for="state"> 是否可用</label>
											<div class="col-sm-9">
												<select id="state" name="state" class="form-control col-10">
													<option value="是">是</option>
													<option value="否">否</option>
												</select>
											</div>
										</div>

									</div>
									
								</form>
							</div>
						</div>
					</div>
					

				</div>



			</div>
			<!-- /.span -->

		</div>

		<#if returnDatas.page??> <@h.pagetoolbar page=returnDatas.page
		formId='searchForm' /> </#if>

	</div>
</div>


<!-- /.main-container -->



</#escape>
