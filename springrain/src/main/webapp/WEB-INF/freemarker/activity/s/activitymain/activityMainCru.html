<#ftl output_format="HTML" auto_esc=true>
<@h.siteCommonHead title="后台管理系统" keywords="开源,永久免费" description="springrain开源系统管理后台"/>

<script src="${ctx}/js/validform/validform.min.js"></script>
<script src="${ctx}/js/ueditor/ueditor.config.js"></script>
<script src="${ctx}/js/ueditor/ueditor.all.js"></script>
<script src="${ctx}/js/ueditor/lang/zh-cn/zh-cn.js"></script>
<script src="${ctx}/js/webuploader/webuploader.min.js"></script>

<link rel="stylesheet" type="text/css" href="${ctx}/js/webuploader/webuploader.css">
<link rel="stylesheet" href="${ctx}/js/validform/validform.css" media="all">
<script>
	 jQuery(function(){
		 var ue = UE.getEditor('container',{
			autoHeight: false
		 });	
		 
		 // 加载封面
		 loadCover();
		 
		 /** 加载日期控件 **/
		 layui.use('laydate',function(){
		 });
		 
		 /*
		 init_valid(_before,_after)
		 @_before:提交表单前，调用 的函数   可以为空，一般有validform处理不了，独自进行处理时使用
		 @_after:保存成功后，调用的函数  可以为空，一般为对应的列表页面
		 */
		 springrain.initValid(null,function(){window.location.href="${ctx}/s/${siteId}/${businessId}/activity/list?springraintoken="+springraintoken});
	 	
		 var uploader = WebUploader.create({
			auto:true,
		    // swf文件路径
		    swf: '${ctx}/js/webuploader/Uploader.swf',
		    // 文件接收服务端。
		    server: '${ctx}/s/${siteId!''}/${businessId!''}/file/logoupload?springraintoken='+springraintoken,
		    // 选择文件的按钮。可选。
		    // 内部根据当前运行是创建，可能是input元素，也可能是flash.
		    pick: '#filePicker',
		    // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
		     accept: {
		        title: 'Images',
		        extensions: 'gif,jpg,jpeg,bmp,png',
		        mimeTypes: 'image/*'
		    }
		});
		
		uploader.on( 'fileQueued', function( file ) {
			$("#tmpLogo").remove();
			var $li = $('<div id="' + file.id + '" class="file-item thumbnail layui-inline">' +
		                '<img>' +
		                '<div class="info">' + file.name + '</div>' 
		                +'</div>'),
	        $img = $li.find('img');


		    // $list为容器jQuery实例
		    $list = $("#fileList");
		    $list.append( $li );

		    // 创建缩略图
		    // 如果为非图片文件，可以不用调用此方法。
		    // thumbnailWidth x thumbnailHeight 为 100 x 100
		    var thumbnailWidth = thumbnailHeight = 100;
		    uploader.makeThumb( file, function( error, src ) {
		        if ( error ) {
		            $img.replaceWith('<span>不能预览</span>');
		            return;
		        }
		        $img.attr( 'src', src );
		    }, thumbnailWidth, thumbnailHeight );
		});
		 
		// 文件上传过程中创建进度条实时显示。
		uploader.on( 'uploadProgress', function( file, percentage ) {
		     var $li = $( '#'+file.id ),
		         $percent = $li.find('.progress span');

		     // 避免重复创建
		     if ( !$percent.length ) {
		         $percent = $('<p class="progress"><span></span></p>')
		                 .appendTo( $li )
		                 .find('span');
		     }

		     $percent.css( 'width', percentage * 100 + '%' );
		 });

		 // 文件上传成功，给item添加成功class, 用样式标记上传成功。
		 uploader.on( 'uploadSuccess', function( file,response ) {
			 var imgJsonArr = response.data;//JSON.stringify();
			 $("#cover").val(JSON.stringify(response.data));
			 //$("#cover").val(imgJsonArr[0].path);
			 //$("[name=cover]").val(JSON.stringify(response.data));
		     $( '#'+file.id ).addClass('upload-state-done');
		 });

		 // 文件上传失败，显示上传出错。
		 uploader.on( 'uploadError', function( file ) {
		     var $li = $( '#'+file.id ),
	         $error = $li.find('div.error');

		     // 避免重复创建
		     if ( !$error.length ) {
		         $error = $('<div class="error"></div>').appendTo( $li );
		     }

		     $error.text('上传失败');
		 });

		 // 完成上传完了，成功或者失败，先删除进度条。
		 uploader.on( 'uploadComplete', function( file ) {
		     $( '#'+file.id ).find('.progress').remove();
		 });
	 
	 });
	 
	 /** 加载封面 **/
	 function loadCover(){
		if($("#cover").val() != ""){
			var logoData = JSON.parse($("#cover").val());
			var imgPath = logoData[0].path;//val();
			$("#tmpLogo").prop("src",ctx + imgPath);
		}
	 }
</script>
</head>
<body>
	<div class="layui-layout layui-layout-admin">
		<@h.naviHeader /><@h.leftMenu />
		<!-- 主体内容开始 -->
			<div class="layui-tab layui-tab-brief">
				<ul class="layui-tab-title site-demo-title">
		             <li style="float:right;">
				        <button type="button" onclick="history.go(-1)" class="layui-btn layui-btn-small" style="margin-top:8px;"><i class="layui-icon layui-icon-specil">&#xe603;</i>返回</button>
		             </li>
	       		</ul>
				
				<div class="layui-body layui-tab-content site-demo-body">
					<div class="layui-tab-item layui-show">
							<div class="layui-main">
						          <div id="LAY_preview" class="layui-my-form">
									<div class="larry-personal-body clearfix changepwd">
										<form id="validForm" class="layui-form <!--  -->"  method="post" action="${ctx}/s/${siteId!''}/${businessId!''}/activity/update">
											<input type="hidden" id="id" name="id" value="${(returnDatas.data.id)!''}"/>	
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">活动标题*</label>
												<div class="layui-inline col-lg-5">  
													<input type="text" name="cmsContent.title" id="title" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.cmsContent.title)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<!-- <div class="layui-form-item col-lg-6">
												<label class="layui-form-label">分类*</label>
												<div class="layui-inline col-lg-5">  
													<select name="category" id="category" lay-verify="required">
														<option value="1" selected="selected">义工活动</option>
														<option value="2" >少年警校</option>
													</select>
													<input type="text" name="category" id="category" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.category)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div> -->
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">封面*</label>
												<div class="layui-inline col-lg-5">
													<div id="uploader-demo">
													     <!--用来存放item-->
													    <img id="tmpLogo" height="100" alt="" src="">
													    <div id="fileList" class="uploader-list"></div>
													    <div id="filePicker" class="">选择图片</div>
													    <input type="hidden" value="${(returnDatas.data.cmsContent.cover)!}" 
													    	id="cover" datatype="*" nullmsg="不能为空" name="cmsContent.cover">
													</div>
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<div class="layui-form-item col-lg-6">
												<div class="layui-form-item col-lg-6">
													<label class="layui-form-label">活动内容*</label>
													<div class="layui-inline col-lg-5">
														<#noautoesc>
															<script id="container" name="cmsContent.content" type="text/plain">${(returnDatas.data.cmsContent.content)!}</script>
														</#noautoesc>
													</div>
													<div class="layui-inline valid-info"></div>
												</div>
											</div>
											<!--日期型-->
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">报名开始时间*</label>
												<div class="layui-inline col-lg-5">  
													<input class="layui-input" placeholder="" onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" 
														name="signupStartTime" id="signupStartTime" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.signupStartTime)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<!--日期型-->
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">报名结束时间*</label>
												<div class="layui-inline col-lg-5">  
													<input class="layui-input" placeholder="" onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" 
														name="signupEndTime" id="signupEndTime" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.signupEndTime)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<!--日期型-->
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">活动开始时间*</label>
												<div class="layui-inline col-lg-5">  
													<input class="layui-input" placeholder="" onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" 
														name="activityStartTime" id="activityStartTime" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.activityStartTime)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<!--日期型-->
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">活动结束时间*</label>
												<div class="layui-inline col-lg-5">  
													<input class="layui-input" placeholder="" onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" 
														name="activityEndTime" id="activityEndTime" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.activityEndTime)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">活动地址*</label>
												<div class="layui-inline col-lg-5">  
													<input type="text" name="activityAddress" id="activityAddress" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.activityAddress)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">参与活动可得积分*</label>
												<div class="layui-inline col-lg-5">  
													<input type="number" name="activityScore" id="activityScore" datatype="*" nullmsg="不能为空" errormsg="不能为空！" autocomplete="off" class="layui-input" value="${(returnDatas.data.activityScore)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">联系电话*</label>
												<div class="layui-inline col-lg-5">  
													<input type="text" name="telPhone" id="telPhone" datatype="m" nullmsg="不能为空" errormsg="不能识别的电话号码！" autocomplete="off" class="layui-input" value="${(returnDatas.data.telPhone)!''}">
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<div class="layui-form-item col-lg-6">
												<label class="layui-form-label">是否可用*</label>
												<div class="layui-inline col-lg-5">  
													<select name="cmsContent.active" id="active" lay-verify="required">
														<#if (returnDatas.data.cmsContent.active)?? && (returnDatas.data.cmsContent.active)==1>
															<option value="1" selected="selected">可用</option>
															<option value="0">不可用</option>
														<#elseif (returnDatas.data.cmsContent.active)?? && (returnDatas.data.cmsContent.active)==0>
															<option value="1" >可用</option>
															<option value="0" selected="selected">不可用</option>
														<#else>
															<option value="1" selected="selected" >可用</option>
															<option value="0" >不可用</option>
														</#if>
													</select>
												</div>
												<div class="layui-inline valid-info"></div>
											</div>
											<div class="layui-form-item change-submit">
												<label class="layui-form-label"></label>
												<div class="layui-inline">
													<button type="button" class="layui-btn" id="smtbtn">保存</button>
													<button type="button" class="layui-btn layui-btn-primary" id="rstbtn">重置</button>
												</div>
											</div>
										</form>
									</div>
								  </div>
							</div>
					</div>
			</div>
		</div>
		<!-- 主体内容结束 -->
		<@h.footer />
	</div>
</body>
</html>
