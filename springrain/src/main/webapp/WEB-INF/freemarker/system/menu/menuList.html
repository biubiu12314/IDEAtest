<#escape x as x?html>
<link rel="stylesheet" href="${ctx}/js/coms/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="${ctx}/js/coms/ztree/js/jquery.ztree.all-3.5.js"></script>
<script type="text/javascript" src="${ctx}/js/coms/common/ztreeUtils.js"></script>

<SCRIPT type="text/javascript">


var selectMenuZtree;
var menujsondata4select;

var menuSelectSetting = {
		callback: {
			onClick: clickMenuValue
		},
	data : {
		simpleData : {
			enable : true,
			idKey : "id",
			pIdKey : "pid",
			rootPId :"null"
		}
	}
};


function clickMenuValue(event, treeId, treeNode) {
	jQuery("#pname").val(treeNode.name);
	jQuery("#pid").val(treeNode.id);
    
    
};

	



	var menuTreesetting = {
		callback: {
			onClick:MenuzTreeOnClick
		},
		data : {
			simpleData : {
				enable : true,
				idKey : "id",
				pIdKey : "pid",
				rootPId : "null"
			}
		}
	};
	
	
	
	$(document).ready(function() {
		
		jQuery.post("${ctx}/system/menu/list/json",
				function(_json) {
					if (_json.status == "success") {
						menujsondata4select=_json;
						$.fn.zTree.init($("#menuListTree"), menuTreesetting,_json.data);
						zTree =$.fn.zTree.getZTreeObj("menuListTree");
					} else {
						myalert(_json.message);
					}
				});
		
	});
	
	function MenuzTreeOnClick(event, treeId, treeNode) {
	    showdata(treeNode);
	};
	
	function showdata(result) {
	    $("#btn_add").hide();
	    $("#btn_update").show();
	    $("#btn_reload").show();
	    $("#btn_delete").show();
	    
		$("#updateForm select ").each(function() {
			$(this).find('option:first').attr('selected', 'selected');
		});
		//console.log(result);
		for (var s in result) {
			set_val(s, result[s]);
			if(s=="iconId"){
				$("#icon").val(result[s]);
			}
		}
		
		var _pid=result["pid"];
		if((!_pid)||_pid==null||_pid=="null"||_pid==""){
			jQuery("#pid").val("");
		}else{
			jQuery("#pid").val(_pid);
		}
		
		
		var _pNode= result.getParentNode();
		if(_pNode){
			jQuery("#pname").val(_pNode["name"]);
		}else{
			jQuery("#pname").val("");
		}
		
	}
	
	
	function deleteMenu(){
		myconfirm('删除这个菜单，是否继续?', function(index){
			var id=jQuery("#id").val();
			if(!id||id==""){
				//myalert("请选择你要删除的记录");
				myalert('请选择你要删除的记录!');
				return false;
			}else{
				//var _url="${ctx}/system/menu/delete?id="+id;
				var _url="${ctx}/system/menu/delete";
				var listurl="${ctx}/system/menu/list";
				//mydelete(_url,listurl);
				var data={"id":id};
				ajaxpostonlayer(_url,listurl,data,'删除菜单成功！');
			}
			  layer.close(index);
		});
	}
	

	
   function dosubmit(i){
		var name=$("#name").val();
		if(name==null||name==''){
			myalert('请填写菜单名称!');
			return false;
		}
/* 		var pageurl=$("#pageurl").val();
		if(pageurl==null||pageurl==''){
			layer.alert('请填写菜单地址！',{icon: 5});
			return false;
		} */
        var msg="菜单添加成功！";
        if(i==1){
        	msg="菜单更新成功！";
        }
        var listurl='${ctx}/system/menu/list';
		submitonlayer("updateForm",listurl,msg);
	}
   

   
	function showMenuZTree(){
		if(!selectMenuZtree){
			$.fn.zTree.init($("#menuZtree"), menuSelectSetting,menujsondata4select.data);
			
			selectMenuZtree =$.fn.zTree.getZTreeObj("menuZtree");
			selectMenuZtree.expandAll(true);
	    	 selectZtreeOneNode(jQuery("#pid").val(),"menuZtree");
		}
		//页面层-自定义
		layer.open({
		  shadeClose:true,
		  closeBtn: 1,
		  btn: ['确定'], //按钮
		  type: 1,
		  title: "选择父菜单",
		  skin: 'layui-layer-rim', //加上边框
		  area: ['600px', '400px'], //宽高
		  //shadeClose: true,
		  content: $("#div_menuZtree")
		});
		
	}


	
	</SCRIPT>

<div class="operate panel panel-default" style="height:65px;">
	<div class="panel-body">
		<div class="pull-right">
			 <@shiro.hasPermission
			name="/system/menu/update" >
			<button id="btn_reload" style="display: none;"  onclick="location.reload();"
				class="btn  btn-sm  btn-primary"  >
				跳转至新增 >>
			</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<button id="btn_add"  onclick="dosubmit(0);"
				class="btn  btn-sm  btn-primary">
				<img src="${ctx}/images/btn_save.png" style="vertical-align: middle;" />保存新增
			</button>
				<button id="btn_update" style="display: none;" onclick="dosubmit(1);"
				class="btn  btn-sm  btn-primary">
				<img src="${ctx}/images/btn_save.png" style="vertical-align: middle;" />保存修改
			</button>
			
			</@shiro.hasPermission>
			 <@shiro.hasPermission name="/system/menu/delete" >
			<button id="btn_delete" style="display: none;" onclick="deleteMenu();" class="btn btn-sm btn-danger">
				 删除
			</button>
			</@shiro.hasPermission>
		</div>
	</div>
</div>
<!-- 功能操作区域结束 -->
<!-- 列表显示区域  -->
<div class="row">
	<div class="col-sm-4">
		<div class="widget-box">
			<div class="widget-header">
				<h4 class="widget-title">菜单</h4>
			</div>
			<div class="widget-body">
				<div class="widget-main">
					<ul id="menuListTree" class="ztree"></ul>
				</div>
			</div>
		</div>
	</div>
	<div class="col-sm-8">
		<div class="widget-box">
			<div class="widget-header">
				<h4 class="widget-title">菜单信息</h4>
			</div>
			<div class="widget-body">
				<div class="widget-main">
					<form id="updateForm" name="updateForm"  action="${ctx}/system/menu/update"   method="post" class="form-horizontal clearfix">
						<input type="hidden" name="id" id="id">
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="name">名称*：</label>
							<div class="col-sm-8">
								<input class="form-control" type="text" id="name" name="name" check="require" msg="请输入名称">
							</div>
						</div>
			
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="url">地址：</label>
							<div class="col-sm-8">
								<input class="form-control" type="text" id="pageurl" name="pageurl">
							</div>
						</div>
			
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="pid">父节点：</label>
							<div class="col-sm-8">
								<div class="input-group">
									<input name="pname" class="form-control val" id="pname" type="text"  readonly="readonly"/>
									<input name="pid"  id="pid" type="hidden" msg="请选择父节点" check="require"  />
									<span class="input-group-btn">
											<a href="javascript:showMenuZTree();" data-title="选择父节点" class="btn btn-sm btn-primary">
												<i class="fa fa-search"></i>
											</a>
									 </span>
								</div>
							</div>
						</div>
						
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="type">资源类型：</label>
							<div class="col-sm-8">
								<select   name="type" id="type" class="form-control">
									<option  value="0">按钮资源</option>
									<option value="1">导航菜单</option>
								</select>
							</div>
						</div>
						
						
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="icon">图标：</label>
							<div class="col-sm-8">
									<input name="icon" class="form-control" id="icon" type="text"  />
							</div>
						</div>
						
						
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="sort">排序：</label>
							<div class="col-sm-8">
								<input class="form-control" type="text" id="sort" name="sort" >
							</div>
						</div>
			
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="state">是否可用*：</label>
							<div class="col-sm-8">
								<select   name="state" id="state" class="form-control">
									<option  value="是">是</option>
									<option value="否">否</option>
								</select>
							</div>
						</div>
			
						<div class="form-group col-xs-9">
							<label class="col-sm-4 control-label" for="description" >备注：</label>
							<div class="col-sm-8" >
								<textarea class="form-control" name="description"  id="description" rows="5" class="col-xs-12" ></textarea>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div></div>
		</div>
		
	</div>
</div>

<div id="div_menuZtree">
	<ul id="menuZtree" class="ztree"></ul>
</div>


</#escape>