<#escape x as x?html> <@h.commonHead title="后台管理系统" keywords="开源,永久免费"
description="springrain开源系统管理后台"/>
<script src="${ctx}/js/custom/common/form.js"></script>
<script type="text/javascript" src="${ctx}/js/ztree/js/jquery.ztree.all-3.5.js"></script>
<script type="text/javascript" src="${ctx}/js/ztree/js/ztreeUtils.js"></script>
<link rel="stylesheet" href="${ctx}/js/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css">
<link rel="stylesheet" href="${ctx}/css/custom/system/orgList.css" type="text/css">
</head>
<body>
	<div class="layui-layout layui-layout-admin">
		<@h.naviHeader /> <@h.leftMenu />
		<!-- 主体内容开始 -->
		<div class="layui-body site-demo">
		<SCRIPT type="text/javascript">
	    var orgTreesetting = {
	        callback: {
	            onClick: orgzTreeOnClick
	        },
	        data : {
	            simpleData : {
	                enable : true,
	                idKey : "id",
	                pIdKey : "pid",
	                rootPId : "null"
	            }
	        }
	    };
    
	    var orgSelectSetting = {
            callback: {
                onClick: clickOrgValue
            },
            data : {
                simpleData : {
                    enable : true,
                    idKey : "id",
                    pIdKey : "pid",
                    rootPId : "null",
                }
            }
        };
	        
	    var selectOrgZtree;
	    var orgjsondata4select;
    

	    $(document).ready(function() {
	        jQuery.post("${ctx}/system/org/list/json",
	        function(_json) {
	            if (_json.status == "success") {
	                orgjsondata4select=_json;
	                $.fn.zTree.init($("#orgListTree"), orgTreesetting,_json.data);
	                var zTree =$.fn.zTree.getZTreeObj("orgListTree");
	                 zTree.expandAll(true);
	            } else {
	                myalert(_json.message);
	            }
	        });
	        
	        //ajaxUserIdSelect2();
	        //ajaxUserIdSelect2("${ctx}/system/user/ajax/select2","managerId",datafunction,selectfunction);
	        //select2ajax("#managerId","${ctx}/system/user/ajax/select2");
	        
	    });
    
    
	    function orgzTreeOnClick(event, treeId, treeNode) {
	        showdata(treeNode);
	    };
	    
	    function clickOrgValue(event, treeId, treeNode) {
	        jQuery("#pname").val(treeNode.name);
	        jQuery("#pid").val(treeNode.id);
	    };
    
	    function showdata(result) {
	        $("#btn_add").hide();
	        $("#btn_update").show();
	        $("#btn_delete").show();
	        $("#btn_reload").show();
	        for (var s in result) {
	            set_val(s, result[s]);
	        }
	        var _pid=result["pid"];
	        if((!_pid)||_pid==null||_pid=="null"||_pid==""){
	            jQuery("#pid").val("");
	        }else{
	            jQuery("#pid").val(_pid);
	        }
	        var _pNode= result.getParentNode();
	        if(_pNode){
	            jQuery("#pname").val(_pNode["name"]);
	        }else{
	            jQuery("#pname").val("");
	        }
        
	        //回选 下拉框
	        jQuery("#state option[value='"+result['state']+"']").prop("selected",true);
	        //设置 主管的下拉框
	        if(result["managerId"]){
	            jQuery("#managerId").empty();
	            jQuery("#managerId").append("<option value='"+result["managerId"]+"'  selected>"+result["managerName"]+"</option>");
	            jQuery("#managerId").trigger("change");
	        }
	    }
    
    
	    function deleteOrg(){
	        var id=jQuery("#id").val();
	        if(!id||id==""){
	            myalert("请选择你要删除的记录");
	            return;
	        }else{
	            var _url="${ctx}/system/org/delete?id="+id;
	            var listurl="${ctx}/system/org/list";
	            mydelete(_url,listurl,{},"部门下的子部门也会被删除,确定要删除部门?");
	        }
	    }
	    function showOrgTree(){
	        if(!selectOrgZtree){
	            $.fn.zTree.init($("#selectOrgTree"), orgSelectSetting,orgjsondata4select.data);
	            
	             selectOrgZtree =$.fn.zTree.getZTreeObj("selectOrgTree");
	             selectOrgZtree.expandAll(true);
	             selectZtreeOneNode(jQuery("#pid").val(),"selectOrgTree");
	        }
	        
	        //页面层-自定义
	        layer.open({
	          shadeClose:true,
	          closeBtn: 1,
	          btn: ['确定'], //按钮
	          type: 1,
	          title: "选择父部门",
	          skin: 'layui-layer-rim', //加上边框
	          area: ['600px', '400px'], //宽高
	          //shadeClose: true,
	          content: $("#div_select_org_tree")
	        });
	    }
	</SCRIPT>
		
		<div class="layui-main">
			<fieldset class="layui-elem-field">
		  		<legend>部门管理</legend>
		  		<div class="layui-field-box">
		    		<button class="layui-btn"><i class="layui-icon"></i> 添加部门</button>
		  		</div>
			</fieldset>
			
			<div class="container-fluid">
				<div class="row">
					<div class="fl per20">
						<ul id="orgListTree" class="ztree"></ul>
					</div>
					<div class="fl per60">
						<form id="updateForm" name="updateForm" method="post" action="${ctx}/system/org/update" class="layui-form">
                        	<input type="hidden" name="id" id="id"> 
                        	<input type="hidden" name="opmode" id="opmode" value="">
                            
                            <div class="layui-form-item per40">
					    		<label class="layui-form-label">名称</label>
							    <div class="layui-input-block">
							      <input datatype="*1-200" errormsg="部门名称长度1--200位之间!" nullmsg="名称不能为空" type="text" id="name" name="name" required  lay-verify="required" placeholder="请输入标题" autocomplete="off" class="layui-input">
							    </div>
						  	</div>
							
							<div class="layui-form-item per40">
					    		<label class="layui-form-label">上级部门</label>
							    <div class="layui-input-block">
							      	<input name="pname" id="pname" readonly="readonly" datatype="*1-200" errormsg="部门名称长度1--200位之间!" nullmsg="名称不能为空" type="text" id="name" name="name" required  lay-verify="required" placeholder="请输入标题" autocomplete="off" class="layui-input">
							    	<input name="pid" id="pid" type="hidden" />
							    </div>
						  	</div>
							
							<div class="layui-form-item per40">
					    		<label class="layui-form-label">主管</label>
							    <div class="layui-input-block">
							      	<select id="managerId" name="managerId" lay-verify="required">
										<option value="是">是</option>
										<option value="否">否</option>
                                    </select>
							    </div>
						  	</div>
							
							<div class="layui-form-item per40">
					    		<label class="layui-form-label">排序</label>
							    <div class="layui-input-block">
							      <input datatype="n1-16" errormsg="请输入正确数值" nullmsg="排序不能为空!" type="text" id="sortno" name="sortno" required  lay-verify="required" placeholder="请输入标题" autocomplete="off" class="layui-input">
							    </div>
						  	</div>
							
							<div class="layui-form-item per40">
					    		<label class="layui-form-label">是否可用</label>
							    <div class="layui-input-block">
							      	<select id="state" name="state" lay-verify="required">
										<option value="是">是</option>
										<option value="否">否</option>
                                    </select>
							    </div>
						  	</div>
						  	
						  	<div class="layui-form-item per40">
					    		<label class="layui-form-label">描述</label>
							    <div class="layui-input-block">
							    	<textarea name="description" id="description" class="layui-textarea"></textarea>
							    </div>
						  	</div>
                         </form>
					</div>
				</div>
			</div>
		</div>	
		<div id="div_select_org_tree">
        	<ul id="selectOrgTree" class="ztree"></ul>
        </div>
		<!-- 主体内容结束 -->
		<@h.footer />
	</div>
</body>
</html>
</#escape>
